; filename: execve-date.nasm
; author: lawly
; description: invokes execve syscall with "/bin/bash -c.." 
;
; nasm -f elf32 -o execve-date.o execve-date.nasm
; ld -N -m elf_i386 -o execve-date execve-date.o  
; 
; char *argv[] = { "/bin/bash", "-c", "/bin/date --date='2 days ago'", NULL }
; execve(argv[0], &argv[0], NULL);

global _start

section .text
_start:

    jmp short call_shellcode

shellcode:
    pop esi

    mov edi, esi

    xor eax, eax
    mov byte [esi+9], al            ; replace all X with null byte 
    mov byte [esi+12], al         
    mov byte [esi+42], al         

    mov dword [esi+43], edi         ; replace AAAA with argv[0]
    add edi, 10
    mov dword [esi+47], edi         ; replace BBBB with argv[1]
    add edi, 3
    mov dword [esi+51], edi         ; replace CCCC with argv[2]
    mov dword [esi+55], eax         ; replace DDDD with dword null

    mov ebx, esi                    ; EBX = argv[0]
    lea ecx, [esi+43]               ; ECX = &argv[0]
    mov edx, eax                    ; EDX = NULL

    xor eax, eax
    mov al, 0xb
    int 0x80

call_shellcode:
    call shellcode
    message:    db  "/bin/bashX-cX/bin/date --date='2 days ago'XAAAABBBBCCCCDDDD"
    ; AAAA: address of "/bin/bash" (argv[0])
    ; BBBB: address of "-c" (argv[1])
    ; CCCC: address of "/bin/date --date='2 days ago'" (argv[2])
    ; DDDD: NULL (argv[3])